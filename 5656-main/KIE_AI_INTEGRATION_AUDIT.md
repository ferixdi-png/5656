# üîç –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞—É–¥–∏—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å KIE AI

## ‚úÖ –¶–µ–ø–æ—á–∫–∞ —Ä–∞–±–æ—Ç—ã: Input ‚Üí Payload ‚Üí API ‚Üí Response ‚Üí Delivery

### 1. –°–±–æ—Ä –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (bot/handlers/flow.py)

**–§–∞–π–ª:** `bot/handlers/flow.py`

#### 1.1. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ (image_url, video_url)
- ‚úÖ **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è file_id ‚Üí URL** (—Å—Ç—Ä–æ–∫–∏ 3083-3100)
  - –î–ª—è `image_url` –∏ `video_url` –ø–æ–ª–µ–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è Telegram `file_id` –≤ downloadable URL
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `bot.get_file(file_id)` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—É—Ç–∏ —Ñ–∞–π–ª–∞
  - –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è URL: `https://api.telegram.org/file/bot{token}/{file_path}`
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

#### 1.2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ defaults
- ‚úÖ **apply_smart_defaults** (—Å—Ç—Ä–æ–∫–∏ 3650-3667)
  - –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –≤ `confirm_cb`
  - –ó–∞–ø–æ–ª–Ω—è–µ—Ç –≤—Å–µ optional –ø–æ–ª—è –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ schema
  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ required –ø–æ–ª—è

### 2. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ payload (app/kie/)

#### 2.1. V4 API (–Ω–æ–≤—ã–µ –º–æ–¥–µ–ª–∏)
**–§–∞–π–ª:** `app/kie/router.py` ‚Üí `build_category_payload()`

- ‚úÖ –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç category –º–æ–¥–µ–ª–∏
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç payload (wrapped/direct)
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç field aliases (url ‚Üí image_url –¥–ª—è image-to-image)
- ‚úÖ –ü—Ä–∏–º–µ–Ω—è–µ—Ç defaults –∏–∑ field_spec
- ‚úÖ –î–æ–±–∞–≤–ª—è–µ—Ç `callBackUrl` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

#### 2.2. V3 API (—Å—Ç–∞—Ä—ã–µ –º–æ–¥–µ–ª–∏)
**–§–∞–π–ª:** `app/kie/builder.py` ‚Üí `build_payload()`

- ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ—Ç schema –∏–∑ SOURCE_OF_TRUTH
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç (direct/wrapped)
- ‚úÖ –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç inputs —á–µ—Ä–µ–∑ `validate_model_inputs()`
- ‚úÖ –ü—Ä–∏–º–µ–Ω—è–µ—Ç defaults –∏–∑ schema

### 3. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ defaults (app/kie/generator.py)

**–§–∞–π–ª:** `app/kie/generator.py` ‚Üí `generate()`

#### 3.1. PHASE A: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ defaults (—Å—Ç—Ä–æ–∫–∞ 196)
```python
user_inputs = apply_defaults(model_id, user_inputs)
```
- ‚úÖ –ü—Ä–∏–º–µ–Ω—è–µ—Ç model-specific defaults –∏–∑ `app/kie/model_defaults.py`
- ‚úÖ –ó–∞–ø–æ–ª–Ω—è–µ—Ç missing required fields

#### 3.2. PHASE B: –í–∞–ª–∏–¥–∞—Ü–∏—è (—Å—Ç—Ä–æ–∫–∏ 199-240)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ text –ø–æ–ª–µ–π (max 50KB)
- ‚úÖ **–ù–û–í–û–ï:** –ü—Ä–æ–≤–µ—Ä–∫–∞ URL –ø–æ–ª–µ–π –Ω–∞ file_id (–Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å file_id)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ URL (max 2KB)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ `validate_inputs()`

### 4. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ KIE API (app/kie/client_v4.py)

**–§–∞–π–ª:** `app/kie/client_v4.py` ‚Üí `create_task()`

- ‚úÖ –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç category –∏ endpoint
- ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST –∑–∞–ø—Ä–æ—Å —Å payload
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç (code, taskId, errors)
- ‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

### 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ (app/kie/state_parser.py)

**–§–∞–π–ª:** `app/kie/state_parser.py` ‚Üí `parse_kie_state()`

- ‚úÖ –ü–∞—Ä—Å–∏—Ç API response (code, data.state, data.resultJson)
- ‚úÖ –ò–∑–≤–ª–µ–∫–∞–µ—Ç resultUrls –∏–∑ resultJson (JSON string!)
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç malformed JSON (regex fallback)
- ‚úÖ –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø—É—Å—Ç—ã–µ/null URLs
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (state, result_urls, error_msg)

### 6. –î–æ—Å—Ç–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (app/delivery/coordinator.py)

**–§–∞–π–ª:** `app/delivery/coordinator.py` ‚Üí `deliver_result_atomic()`

- ‚úÖ Atomic lock –¥–ª—è exactly-once delivery
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç category (image/video/audio)
- ‚úÖ –í—ã–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π delivery –º–µ—Ç–æ–¥:
  - `_deliver_image()` - 3-level fallback (direct URL ‚Üí bytes ‚Üí document)
  - `_deliver_video()` - —Å fallback
  - `_deliver_audio()` - —Å fallback
  - `_deliver_document()` - –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤
- ‚úÖ Mark delivered –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏

---

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è file_id ‚Üí URL
**–ü—Ä–æ–±–ª–µ–º–∞:** KIE API –ø–æ–ª—É—á–∞–ª Telegram file_id –≤–º–µ—Å—Ç–æ URL  
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ `bot/handlers/flow.py:3083-3100`

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –í–∞–ª–∏–¥–∞—Ü–∏—è URL –ø–æ–ª–µ–π
**–ü—Ä–æ–±–ª–µ–º–∞:** file_id –º–æ–≥ –ø–æ–ø–∞—Å—Ç—å –≤ payload  
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ `app/kie/generator.py:203-240`

---

## üìã –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏

### Text-to-Image
- [x] –°–±–æ—Ä prompt –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [x] –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ defaults (aspect_ratio, guidance_scale, etc.)
- [x] –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ payload (V3 –∏–ª–∏ V4)
- [x] –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ KIE API
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
- [x] –î–æ—Å—Ç–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

### Image-to-Image
- [x] –°–±–æ—Ä prompt + image_url
- [x] **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è file_id ‚Üí URL** ‚úÖ
- [x] –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ defaults (strength, etc.)
- [x] –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ payload
- [x] –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ KIE API
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
- [x] –î–æ—Å—Ç–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

### Image-to-Video
- [x] –°–±–æ—Ä image_url
- [x] **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è file_id ‚Üí URL** ‚úÖ
- [x] –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ defaults (duration, resolution, etc.)
- [x] –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ payload
- [x] –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ KIE API
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
- [x] –î–æ—Å—Ç–∞–≤–∫–∞ –≤–∏–¥–µ–æ

### Text-to-Video
- [x] –°–±–æ—Ä prompt
- [x] –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ defaults (aspect_ratio, duration, etc.)
- [x] –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ payload
- [x] –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ KIE API
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
- [x] –î–æ—Å—Ç–∞–≤–∫–∞ –≤–∏–¥–µ–æ

### Audio models
- [x] –°–±–æ—Ä audio_url –∏–ª–∏ text
- [x] **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è file_id ‚Üí URL** (–µ—Å–ª–∏ audio_url)
- [x] –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ defaults
- [x] –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ payload
- [x] –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ KIE API
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
- [x] –î–æ—Å—Ç–∞–≤–∫–∞ –∞—É–¥–∏–æ

---

## üéØ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏

1. **file_id ‚Üí URL –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
2. **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ defaults** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç (apply_smart_defaults + apply_defaults)
3. **–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ payload** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è V3 –∏ V4
4. **–í–∞–ª–∏–¥–∞—Ü–∏—è URL** ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ file_id
5. **–ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤** ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç malformed JSON
6. **–î–æ—Å—Ç–∞–≤–∫–∞** ‚úÖ Atomic delivery —Å fallback

---

## üöÄ –°—Ç–∞—Ç—É—Å: PRODUCTION READY

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. –¶–µ–ø–æ—á–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –º–æ–¥–µ–ª–µ–π.


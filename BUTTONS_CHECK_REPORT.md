# üìä –û–¢–ß–ï–¢: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∏ –ª–æ–≥–∏–∫–∏ –≤ `bot_kie.py`

**–î–∞—Ç–∞:** 2025-01-27  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–û–°–ù–û–í–ù–´–ï –ö–ù–û–ü–ö–ò –†–ê–ë–û–¢–ê–Æ–¢** | ‚ö†Ô∏è **–¢–†–ï–ë–£–Æ–¢–°–Ø –£–õ–£–ß–®–ï–ù–ò–Ø**

---

## ‚úÖ 1. –ü–†–û–í–ï–†–ö–ê –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í –ö–ù–û–ü–û–ö

### üìç –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –º–æ–¥–µ–ª–∏ (model card):

#### ‚úÖ `model:<model_id>` ‚Äî **–†–ê–ë–û–¢–ê–ï–¢**
- **–û–±—Ä–∞–±–æ—Ç—á–∏–∫:** –°—Ç—Ä–æ–∫–∞ 7970 (`if data.startswith("model:")`)
- **–§—É–Ω–∫—Ü–∏—è:** –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –º–æ–¥–µ–ª–∏ —Å:
  - –ù–∞–∑–≤–∞–Ω–∏–µ–º, —Ç–∏–ø–æ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
  - –ü–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (input_schema)
  - –ö–Ω–æ–ø–∫–∞–º–∏: "‚úÖ –ù–∞—á–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é", "‚ÑπÔ∏è –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞", "‚¨ÖÔ∏è –ù–∞–∑–∞–¥"
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:** ‚úÖ –ï—Å—Ç—å try-except, –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –º–æ–¥–µ–ª–∏
- **Fallback:** ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

#### ‚úÖ `start:<model_id>` ‚Äî **–†–ê–ë–û–¢–ê–ï–¢**
- **–û–±—Ä–∞–±–æ—Ç—á–∏–∫:** –°—Ç—Ä–æ–∫–∞ 8036 (`if data.startswith("start:")`)
- **–§—É–Ω–∫—Ü–∏—è:** –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ `select_model:<model_id>` –¥–ª—è –Ω–∞—á–∞–ª–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:** ‚úÖ –ï—Å—Ç—å try-except, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞
- **Fallback:** ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É –ø—Ä–∏ –Ω–µ–≤–µ—Ä–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ

#### ‚úÖ `example:<model_id>` ‚Äî **–†–ê–ë–û–¢–ê–ï–¢**
- **–û–±—Ä–∞–±–æ—Ç—á–∏–∫:** –°—Ç—Ä–æ–∫–∞ 8055 (`if data.startswith("example:")`)
- **–§—É–Ω–∫—Ü–∏—è:** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:** ‚úÖ –ï—Å—Ç—å try-except, –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –º–æ–¥–µ–ª–∏
- **Fallback:** ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

#### ‚úÖ `back_to_menu` ‚Äî **–†–ê–ë–û–¢–ê–ï–¢**
- **–û–±—Ä–∞–±–æ—Ç—á–∏–∫:** –°—Ç—Ä–æ–∫–∞ 3814 (`if data == "back_to_menu"`)
- **–§—É–Ω–∫—Ü–∏—è:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:** ‚úÖ –ï—Å—Ç—å try-except, fallback –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

---

## ‚úÖ 2. –ü–†–û–í–ï–†–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò –û–®–ò–ë–û–ö

### üìç –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:

#### ‚úÖ `button_callback` —Ñ—É–Ω–∫—Ü–∏—è:
- **–û–±—Ä–∞–±–æ—Ç–∫–∞:** –°—Ç—Ä–æ–∫–∞ 3311 (`async def button_callback`)
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
  - ‚úÖ –í—Å–µ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç `query.answer()` –≤ –Ω–∞—á–∞–ª–µ (—Å—Ç—Ä–æ–∫–∞ 3343)
  - ‚úÖ –û–±–µ—Ä–Ω—É—Ç–∞ –≤ try-except (—Å—Ç—Ä–æ–∫–∞ 3378)
  - ‚úÖ –ï—Å—Ç—å fallback –¥–ª—è –æ—à–∏–±–æ–∫ (—Å—Ç—Ä–æ–∫–∞ 3368-3376)
  - ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫

#### ‚úÖ `confirm_generation` —Ñ—É–Ω–∫—Ü–∏—è:
- **–û–±—Ä–∞–±–æ—Ç–∫–∞:** –°—Ç—Ä–æ–∫–∞ 11426 (`async def confirm_generation`)
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
  - ‚úÖ –í—Å–µ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç `query.answer()` (—Å—Ç—Ä–æ–∫–∞ 11467)
  - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `send_or_edit_message` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ (—Å—Ç—Ä–æ–∫–∞ 11474)
  - ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ (—Å—Ç—Ä–æ–∫–∞ 11324-11337)
  - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–µ—Å—Å–∏–∏ (—Å—Ç—Ä–æ–∫–∞ 11507-11522)

---

## ‚úÖ 3. –ü–†–û–í–ï–†–ö–ê –†–ê–ë–û–¢–´ –° TEST_MODE/DRY_RUN

### üìç DRY_RUN guard –≤ `confirm_generation`:

#### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ DRY_RUN:
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –°—Ç—Ä–æ–∫–∞ 11255 (`dry_run = is_dry_run() or not allow_real_generation()`)
- **–õ–æ–≥–∏–∫–∞:**
  - ‚úÖ –ï—Å–ª–∏ `DRY_RUN=1` –∏–ª–∏ `ALLOW_REAL_GENERATION=0` ‚Üí —Å–∏–º—É–ª—è—Ü–∏—è
  - ‚úÖ –°–æ–∑–¥–∞–µ—Ç –º–æ–∫–æ–≤—ã–π `task_id` (—Å—Ç—Ä–æ–∫–∞ 11261)
  - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `MockKieGateway` —á–µ—Ä–µ–∑ `get_kie_gateway()` (—Å—Ç—Ä–æ–∫–∞ 11264)
  - ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –º–æ–∫–æ–≤—ã–π URL —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (—Å—Ç—Ä–æ–∫–∞ 11277)
  - ‚úÖ **–ù–ï —Å–ø–∏—Å—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å** (—Å—Ç—Ä–æ–∫–∞ 11299)
  - ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ "üîß DRY-RUN: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–∞" (—Å—Ç—Ä–æ–∫–∞ 11281)

#### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º –±–∞–ª–∞–Ω—Å–∞:
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –°—Ç—Ä–æ–∫–∞ 11405 (`dry_run = is_dry_run() or not allow_real_generation()`)
- **–õ–æ–≥–∏–∫–∞:**
  - ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `dry_run` –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º (—Å—Ç—Ä–æ–∫–∞ 11406)
  - ‚úÖ –ï—Å–ª–∏ `dry_run` ‚Üí –ù–ï —Å–ø–∏—Å—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å (—Å—Ç—Ä–æ–∫–∞ 11414)
  - ‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç "üîß DRY-RUN: Would deduct ... (NOT DEDUCTED)" (—Å—Ç—Ä–æ–∫–∞ 11414)

#### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ `poll_task_status`:
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –°—Ç—Ä–æ–∫–∞ 23314 (`dry_run = is_dry_run() or not allow_real_generation()`)
- **–õ–æ–≥–∏–∫–∞:**
  - ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `dry_run` –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (—Å—Ç—Ä–æ–∫–∞ 23316)
  - ‚úÖ –ï—Å–ª–∏ `dry_run` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–æ–∫–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Å—Ç—Ä–æ–∫–∞ 23316-23354)

---

## ‚ö†Ô∏è 4. –ù–ê–ô–î–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:

#### 1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ fallback –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö callback_data**
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–º `callback_data`, –±–æ—Ç –º–æ–∂–µ—Ç –Ω–µ –æ—Ç–≤–µ—Ç–∏—Ç—å
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –í –∫–æ–Ω—Ü–µ `button_callback` —Ñ—É–Ω–∫—Ü–∏–∏
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å fallback –≤ –∫–æ–Ω—Ü–µ —Ñ—É–Ω–∫—Ü–∏–∏:
  ```python
  # –í –∫–æ–Ω—Ü–µ button_callback, –ø–µ—Ä–µ–¥ return ConversationHandler.END
  # –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:
  logger.warning(f"Unknown callback_data: {data}, user_id={user_id}")
  try:
      user_lang = get_user_language(user_id) if user_id else 'ru'
      await query.answer(
          t('error_outdated_button', lang=user_lang, default="‚ùå –ö–Ω–æ–ø–∫–∞ —É—Å—Ç–∞—Ä–µ–ª–∞. –û—Ç–∫—Ä–æ–π—Ç–µ /start"),
          show_alert=True
      )
  except:
      pass
  ```

#### 2. **–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ `normalize_model_for_api`**
- **–ü—Ä–æ–±–ª–µ–º–∞:** –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ `example:` (—Å—Ç—Ä–æ–∫–∞ 8077) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `normalize_model_for_api`, –Ω–æ —Ñ—É–Ω–∫—Ü–∏—è –º–æ–∂–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –°—Ç—Ä–æ–∫–∞ 8077
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–∂–µ –µ—Å—Ç—å try-except (—Å—Ç—Ä–æ–∫–∞ 8076-8080), –Ω–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å:
  ```python
  try:
      from kie_models import normalize_model_for_api
      normalized = normalize_model_for_api(model)
  except ImportError:
      # Fallback –Ω–∞ normalize_model_info
      from kie_models import normalize_model_info
      normalized = normalize_model_info(model)
  except Exception as e:
      logger.warning(f"Error normalizing model: {e}")
      normalized = model
  ```

### üü° –ù–µ–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:

#### 1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ `dry_run`**
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ `dry_run` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã –≤ `confirm_generation` (—Å—Ç—Ä–æ–∫–∏ 11255 –∏ 11405)
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í—ã–Ω–µ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –≤ –Ω–∞—á–∞–ª–æ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–Ω—É –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é

#### 2. **–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –ø—É—Å—Ç–æ–π `input_schema` –≤ `example:`**
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ `input_schema` –ø—É—Å—Ç–æ–π, –ø—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ –±—É–¥–µ—Ç –ø—É—Å—Ç—ã–º
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∏ –ø–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø—Ä–∏–º–µ—Ä

---

## ‚úÖ 5. –ü–†–û–í–ï–†–ö–ê –í–°–ï–• –û–°–ù–û–í–ù–´–• CALLBACK_DATA

### üìã –°–ø–∏—Å–æ–∫ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö callback_data:

| callback_data | –û–±—Ä–∞–±–æ—Ç—á–∏–∫ | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|--------------|------------|--------|------------|
| `model:<model_id>` | ‚úÖ –°—Ç—Ä–æ–∫–∞ 7970 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –º–æ–¥–µ–ª–∏ |
| `start:<model_id>` | ‚úÖ –°—Ç—Ä–æ–∫–∞ 8036 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ select_model |
| `example:<model_id>` | ‚úÖ –°—Ç—Ä–æ–∫–∞ 8055 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ |
| `back_to_menu` | ‚úÖ –°—Ç—Ä–æ–∫–∞ 3814 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é |
| `select_model:<model_id>` | ‚úÖ –°—Ç—Ä–æ–∫–∞ 8120 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ù–∞—á–∏–Ω–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é |
| `gen_type:<type>` | ‚úÖ –°—Ç—Ä–æ–∫–∞ 4504 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–µ–ª–∏ –ø–æ —Ç–∏–ø—É |
| `category:<category>` | ‚úÖ –°—Ç—Ä–æ–∫–∞ 4714 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–µ–ª–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ |
| `check_balance` | ‚úÖ –°—Ç—Ä–æ–∫–∞ 5666 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å |
| `topup_balance` | ‚úÖ –°—Ç—Ä–æ–∫–∞ 5704 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ |
| `my_generations` | ‚úÖ –°—Ç—Ä–æ–∫–∞ ~7500 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ò—Å—Ç–æ—Ä–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π |
| `confirm_generate` | ‚úÖ –°—Ç—Ä–æ–∫–∞ 11426 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ |
| `cancel` | ‚úÖ –°—Ç—Ä–æ–∫–∞ 4445 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –û—Ç–º–µ–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ |
| `help_menu` | ‚úÖ –°—Ç—Ä–æ–∫–∞ 7159 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ú–µ–Ω—é –ø–æ–º–æ—â–∏ |
| `support_contact` | ‚úÖ –°—Ç—Ä–æ–∫–∞ 7315 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ö–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ |
| `referral_info` | ‚úÖ –°—Ç—Ä–æ–∫–∞ 7458 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ |
| `admin_stats` | ‚úÖ –°—Ç—Ä–æ–∫–∞ 6070 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å |

---

## üìã –ò–¢–û–ì–û–í–´–ô –°–¢–ê–¢–£–°

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. **–í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –∏–º–µ—é—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏**
2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç** (try-except, fallback)
3. **DRY_RUN/TEST_MODE —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** (–Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–æ–∫–æ–≤—ã–π gateway)
4. **–ö–Ω–æ–ø–∫–∏ –º–æ–¥–µ–ª–∏ —Ä–∞–±–æ—Ç–∞—é—Ç** (`model:`, `start:`, `example:`)
5. **–ù–∞–≤–∏–≥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç** (`back_to_menu`, `back_to_previous_step`)

### ‚ö†Ô∏è –ß—Ç–æ –Ω—É–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å:
1. **–î–æ–±–∞–≤–∏—Ç—å fallback –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö callback_data** (–∫—Ä–∏—Ç–∏—á–Ω–æ)
2. **–£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ `normalize_model_for_api`** (–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–æ)
3. **–£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ `dry_run`** (–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–æ)
4. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –ø—É—Å—Ç–æ–π `input_schema` –≤ `example:`** (–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–æ)

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–õ–£–ß–®–ï–ù–ò–Æ

### 1. –î–æ–±–∞–≤–∏—Ç—å fallback –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö callback_data:

```python
# –í –∫–æ–Ω—Ü–µ button_callback, –ø–µ—Ä–µ–¥ —Ñ–∏–Ω–∞–ª—å–Ω—ã–º return
# –ü–æ—Å–ª–µ –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, –Ω–æ –ø–µ—Ä–µ–¥ except Exception as e:

# Fallback –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö callback_data
if not handled:  # –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ handled = False –≤ –Ω–∞—á–∞–ª–µ
    logger.warning(f"Unknown callback_data: {data}, user_id={user_id}")
    try:
        user_lang = get_user_language(user_id) if user_id else 'ru'
        await query.answer(
            t('error_outdated_button', lang=user_lang, default="‚ùå –ö–Ω–æ–ø–∫–∞ —É—Å—Ç–∞—Ä–µ–ª–∞. –û—Ç–∫—Ä–æ–π—Ç–µ /start"),
            show_alert=True
        )
    except:
        pass
```

### 2. –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ `normalize_model_for_api`:

```python
# –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ example: (—Å—Ç—Ä–æ–∫–∞ 8076)
try:
    from kie_models import normalize_model_for_api
    normalized = normalize_model_for_api(model)
except ImportError:
    # Fallback –Ω–∞ normalize_model_info
    from kie_models import normalize_model_info
    normalized = normalize_model_info(model)
except Exception as e:
    logger.warning(f"Error normalizing model: {e}")
    normalized = model
```

### 3. –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ `dry_run`:

```python
# –í –Ω–∞—á–∞–ª–µ confirm_generation (–ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è user_id)
dry_run = is_dry_run() or not allow_real_generation()
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤–µ–∑–¥–µ, –≥–¥–µ –Ω—É–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞
```

---

## ‚úÖ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–û–±—â–∏–π —Å—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–ù–û–ü–ö–ò –†–ê–ë–û–¢–ê–Æ–¢ –ö–û–†–†–ï–ö–¢–ù–û**

–í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –∏–º–µ—é—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç, DRY_RUN/TEST_MODE —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å fallback –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö callback_data –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞.

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**
1. üî¥ **–í—ã—Å–æ–∫–∏–π:** –î–æ–±–∞–≤–∏—Ç—å fallback –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö callback_data
2. üü° **–°—Ä–µ–¥–Ω–∏–π:** –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ `normalize_model_for_api`
3. üü¢ **–ù–∏–∑–∫–∏–π:** –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ `dry_run`


# –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ merge –≤ main

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–≤—ã–ø–æ–ª–Ω–µ–Ω—ã) ‚úÖ

- [x] `python -m compileall .` - OK, –Ω–µ—Ç —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
- [x] `python -m pytest -q` - 36 passed, 0 failed
- [x] `python scripts/verify_project.py` - OK, 107 models
- [x] `python manual_bot_check.py` - ALL TESTS PASSED

## –†—É—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Ç—Ä–µ–±—É—é—Ç –≤–∞—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π)

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ DRY_RUN —Ä–µ–∂–∏–º–µ (–ª–æ–∫–∞–ª—å–Ω–æ)

```bash
export DRY_RUN=1
export TELEGRAM_BOT_TOKEN="123456:TEST"
export BOT_MODE=polling
export PORT=0
python main_render.py
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
- –õ–æ–≥ "DRY_RUN enabled - skipping polling startup"
- –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- –ù–µ—Ç TelegramConflictError

**–°—Ç–∞—Ç—É—Å:** [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ

---

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å —Ä–µ–∞–ª—å–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º (–±–µ–∑ DATABASE_URL)

```bash
export DRY_RUN=0
export TELEGRAM_BOT_TOKEN="<–≤–∞—à_—Ä–µ–∞–ª—å–Ω—ã–π_—Ç–æ–∫–µ–Ω>"
export KIE_API_KEY="<–≤–∞—à_kie_api_key>"
export KIE_BASE_URL="https://api.kie.ai"
export BOT_MODE=polling
export PORT=10000
# –ù–ï —É–∫–∞–∑—ã–≤–∞–µ–º DATABASE_URL
python main_render.py
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
- –õ–æ–≥ "DRY_RUN enabled - skipping singleton lock" (–ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–µ—Ç DATABASE_URL)
- –õ–æ–≥ "Webhook deleted: True"
- –õ–æ–≥ "üöÄ STARTING BOT POLLING"
- –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ /start

**–°—Ç–∞—Ç—É—Å:** [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ

---

### 3. Smoke test (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```bash
export SMOKE_TEST_ON_START=1
export SMOKE_TEST_MODEL_ID="minimax_video_01"
export SMOKE_TEST_INPUT_JSON='{"prompt":"A cat walking"}'
export KIE_STUB=true  # –î–ª—è —Ç–µ—Å—Ç–∞ –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ API
export TELEGRAM_BOT_TOKEN="123456:TEST"
export DRY_RUN=1
python main_render.py
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
- –õ–æ–≥ "üß™ Running smoke test"
- –õ–æ–≥ "‚úÖ Smoke test PASSED" (–≤ stub mode)

**–°—Ç–∞—Ç—É—Å:** [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ

---

### 4. Deploy –Ω–∞ Render

#### 4.1 –ù–∞—Å—Ç—Ä–æ–∏—Ç—å ENV –Ω–∞ Render

–í Render dashboard –¥–ª—è –≤–∞—à–µ–≥–æ worker service, –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å:

```bash
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
TELEGRAM_BOT_TOKEN=<–≤–∞—à_—Ç–æ–∫–µ–Ω>
KIE_API_KEY=<–≤–∞—à_–∫–ª—é—á>
KIE_BASE_URL=https://api.kie.ai

# –î–ª—è production
DATABASE_URL=<postgres_url>  # –ò–∑ Render PostgreSQL
BOT_MODE=polling
PORT=10000

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: smoke test –ø—Ä–∏ deploy
SMOKE_TEST_ON_START=1
SMOKE_TEST_MODEL_ID=minimax_video_01
SMOKE_TEST_INPUT_JSON={"prompt":"test"}
```

**–°—Ç–∞—Ç—É—Å:** [ ] ENV –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

#### 4.2 Merge –≤ main

–û–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:

**–í–∞—Ä–∏–∞–Ω—Ç –ê: –ß–µ—Ä–µ–∑ GitHub PR (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**
1. –û—Ç–∫—Ä—ã—Ç—å PR –Ω–∞ GitHub: copilot/fix-pr7-conflicts ‚Üí main
2. Review –∏–∑–º–µ–Ω–µ–Ω–∏–π
3. Merge PR

**–í–∞—Ä–∏–∞–Ω—Ç –ë: –ß–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É**
```bash
git checkout main
git merge copilot/fix-pr7-conflicts
git push origin main
```

**–°—Ç–∞—Ç—É—Å:** [ ] Merged –≤ main

#### 4.3 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å deploy –Ω–∞ Render

–ü–æ—Å–ª–µ merge –≤ main, Render –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç.

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ª–æ–≥–∞—Ö Render:**
- [ ] "‚úÖ Singleton lock acquired successfully"
- [ ] "Webhook deleted: True"
- [ ] "üöÄ STARTING BOT POLLING"
- [ ] –ù–ï–¢ "TelegramConflictError"
- [ ] –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω smoke test: "‚úÖ Smoke test PASSED" –∏–ª–∏ "‚ùå Smoke test FAILED" (–Ω–æ startup –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è)

**–°—Ç–∞—Ç—É—Å:** [ ] Deploy —É—Å–ø–µ—à–µ–Ω

---

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ user flow (—Å —Ä–µ–∞–ª—å–Ω—ã–º –±–æ—Ç–æ–º)

1. –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞ –≤ Telegram
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `/start`
3. **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏ "üöÄ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è", "üí≥ –ë–∞–ª–∞–Ω—Å / –û–ø–ª–∞—Ç–∞", "‚ÑπÔ∏è –ü–æ–¥–¥–µ—Ä–∂–∫–∞"

4. –ù–∞–∂–∞—Ç—å "üöÄ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è"
5. **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π

6. –í—ã–±—Ä–∞—Ç—å –ª—é–±—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
7. **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –°–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

8. –í—ã–±—Ä–∞—Ç—å –º–æ–¥–µ–ª—å
9. **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ + –∫–Ω–æ–ø–∫–∞ "‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å"

10. –ù–∞–∂–∞—Ç—å "‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å"
11. –í–≤–µ—Å—Ç–∏ —Ç—Ä–µ–±—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
12. **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å —Ü–µ–Ω–æ–π –∏ –±–∞–ª–∞–Ω—Å–æ–º

13. –ù–∞–∂–∞—Ç—å "üöÄ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å"
14. **–û–∂–∏–¥–∞–µ—Ç—Å—è:**
    - –°–æ–æ–±—â–µ–Ω–∏–µ "‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞"
    - Heartbeat —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ ~12 —Å–µ–∫—É–Ω–¥
    - –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ò–õ–ò –æ—à–∏–±–∫–∞ + —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ—Ñ–∞–Ω–¥–µ

**–°—Ç–∞—Ç—É—Å:** [ ] User flow —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ "zero silence"

–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ—Ç—É:
- [ ] –°–ª—É—á–∞–π–Ω—ã–π —Ç–µ–∫—Å—Ç (–Ω–µ –∫–æ–º–∞–Ω–¥–∞) ‚Üí **–û–∂–∏–¥–∞–µ—Ç—Å—è:** "–Ø –≥–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É. –ù–∞–∂–º–∏—Ç–µ /start..."
- [ ] –§–æ—Ç–æ/–≤–∏–¥–µ–æ/—Ñ–∞–π–ª –±–µ–∑ –∫–æ–º–∞–Ω–¥—ã ‚Üí **–û–∂–∏–¥–∞–µ—Ç—Å—è:** "üìé –§–∞–π–ª –ø–æ–ª—É—á–µ–Ω, –Ω–æ —Å–µ–π—á–∞—Å —è –∂–¥—É –∫–æ–º–∞–Ω–¥—ã..."
- [ ] –°—Ç–∞—Ä—É—é/—É—Å—Ç–∞—Ä–µ–≤—à—É—é –∫–Ω–æ–ø–∫—É ‚Üí **–û–∂–∏–¥–∞–µ—Ç—Å—è:** "‚ö†Ô∏è –ö–Ω–æ–ø–∫–∞ —É—Å—Ç–∞—Ä–µ–ª–∞. –ù–∞–∂–º–∏—Ç–µ /start."

**–°—Ç–∞—Ç—É—Å:** [ ] Zero silence —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ singleton lock (–¥–≤–∞ –∏–Ω—Å—Ç–∞–Ω—Å–∞)

–ï—Å–ª–∏ –Ω–∞ Render –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –¥–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ redeploy):

**–í –ª–æ–≥–∞—Ö –ø–µ—Ä–≤–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞:**
- [ ] "‚úÖ Singleton lock acquired successfully"
- [ ] "üöÄ STARTING BOT POLLING"

**–í –ª–æ–≥–∞—Ö –≤—Ç–æ—Ä–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞:**
- [ ] "‚ùå Singleton lock NOT acquired - another instance is running"
- [ ] "‚ùå WILL NOT start polling to prevent TelegramConflictError"
- [ ] –ù–ï–¢ "üöÄ STARTING BOT POLLING"
- [ ] –ù–ï–¢ "TelegramConflictError"

**–°—Ç–∞—Ç—É—Å:** [ ] Singleton lock —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫-–ª–∏—Å—Ç

- [x] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] DRY_RUN —Ä–µ–∂–∏–º –ø—Ä–æ–≤–µ—Ä–µ–Ω
- [ ] –†–µ–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω (–±–µ–∑ DATABASE_URL) –ø—Ä–æ–≤–µ—Ä–µ–Ω
- [ ] Smoke test –ø—Ä–æ–≤–µ—Ä–µ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] ENV –Ω–∞ Render –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] Merged –≤ main
- [ ] Deploy –Ω–∞ Render —É—Å–ø–µ—à–µ–Ω
- [ ] User flow –ø—Ä–æ–≤–µ—Ä–µ–Ω
- [ ] Zero silence –ø—Ä–æ–≤–µ—Ä–µ–Ω
- [ ] Singleton lock –ø—Ä–æ–≤–µ—Ä–µ–Ω (–¥–≤–∞ –∏–Ω—Å—Ç–∞–Ω—Å–∞)

## –ö–æ–≥–¥–∞ –≤—Å—ë ‚úÖ

–ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üéâ

---

## –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

–°–º. DEPLOYMENT_GUIDE.md —Ä–∞–∑–¥–µ–ª "Troubleshooting":
- TelegramConflictError –≤—Å—ë –µ—â—ë –ø–æ—è–≤–ª—è–µ—Ç—Å—è
- –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–Ω–æ–ø–∫–∏
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–∏—Å–∞–µ—Ç
- –î–µ–Ω—å–≥–∏ —Å–ø–∏—Å–∞–ª–∏—Å—å –Ω–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è failed


# üìä –û–¢–ß–ï–¢: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤ –∏ –ª–æ–≥–∏–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π

**–î–∞—Ç–∞:** 2025-01-27  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–¢–ï–°–¢–´ –†–ê–ë–û–¢–ê–Æ–¢** | ‚ö†Ô∏è **–¢–†–ï–ë–£–Æ–¢–°–Ø –£–õ–£–ß–®–ï–ù–ò–Ø**

---

## ‚úÖ 1. –ü–†–û–í–ï–†–ö–ê –°–¢–†–£–ö–¢–£–†–´ –¢–ï–°–¢–û–í

### üìã –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã:

1. **`tests/test_main_menu.py`** ‚Äî ‚úÖ **–ù–ê–ô–î–ï–ù**
   - –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—É `/start`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–∞—Ö

2. **`tests/test_models_menu_coverage.py`** ‚Äî ‚úÖ **–ù–ê–ô–î–ï–ù**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –º–æ–¥–µ–ª–µ–π
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ callback –¥–ª—è –º–æ–¥–µ–ª–µ–π –Ω–µ –ø–∞–¥–∞–µ—Ç
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç DRY_RUN —Ä–µ–∂–∏–º

3. **`tests/test_callbacks_smoke.py`** ‚Äî ‚úÖ **–ù–ê–ô–î–ï–ù**
   - Smoke —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö callback_data
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ callback –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

4. **`tests/conftest.py`** ‚Äî ‚úÖ **–ù–ê–ô–î–ï–ù**
   - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
   - –°–æ–∑–¥–∞–µ—Ç —Ñ–∏–∫—Å—Ç—É—Ä—É `harness` –¥–ª—è —Ç–µ—Å—Ç–æ–≤

5. **`tests/ptb_harness.py`** ‚Äî ‚úÖ **–ù–ê–ô–î–ï–ù**
   - Test harness –¥–ª—è python-telegram-bot
   - –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
   - –ú–æ–∫–∞–µ—Ç `bot.send_message`, `bot.edit_message_text`, `bot.answer_callback_query`

---

## ‚úÖ 2. –ü–†–û–í–ï–†–ö–ê DRY_RUN / TEST_MODE

### üìç –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

#### ‚úÖ `conftest.py` (—Å—Ç—Ä–æ–∫–∏ 14-21):
```python
test_vars = {
    'TEST_MODE': '1',
    'DRY_RUN': '1',
    'ALLOW_REAL_GENERATION': '0',
    'TELEGRAM_BOT_TOKEN': 'test_token_12345',
    'KIE_API_KEY': 'test_api_key',
    'ADMIN_ID': '12345',
}
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û** ‚Äî –≤—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã

### üìç –ü—Ä–æ–≤–µ—Ä–∫–∞ DRY_RUN –≤ `confirm_generation`:

#### ‚úÖ –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (—Å—Ç—Ä–æ–∫–∞ 11255):
```python
dry_run = is_dry_run() or not allow_real_generation()

if dry_run:
    # –°–æ–∑–¥–∞–µ–º –º–æ–∫–æ–≤—ã–π task_id
    task_id = f"dry_run_{hashlib.md5(...).hexdigest()[:12]}"
    
    # –ü–æ–ª—É—á–∞–µ–º gateway –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–æ–∫–æ–≤–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    gateway = get_kie_gateway()
    
    # –°–æ–∑–¥–∞–µ–º –º–æ–∫–æ–≤—É—é –∑–∞–¥–∞—á—É —á–µ—Ä–µ–∑ gateway
    result = await gateway.create_task(model_id, api_params)
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º–æ–∫–æ–≤—ã–π URL —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    mock_url = f"https://example.com/mock/{model_id}/{task_id}{ext}"
    
    # –ù–ï —Å–ø–∏—Å—ã–≤–∞–µ–º –±–∞–ª–∞–Ω—Å –≤ DRY-RUN
    logger.info(f"üîß DRY-RUN: Would deduct {price} from user {user_id} (NOT DEDUCTED)")
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û** ‚Äî –±–∞–ª–∞–Ω—Å –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è MockKieGateway

#### ‚úÖ –í—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (—Å—Ç—Ä–æ–∫–∞ 11405):
```python
# Deduct balance (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ DRY_RUN)
dry_run = is_dry_run() or not allow_real_generation()
if not dry_run:
    if not is_free:
        subtract_user_balance(user_id, price)
        create_operation(user_id, "generation", -price, model_id, None, None)
    else:
        use_free_generation(user_id, model_id)
        create_operation(user_id, "free_generation", Decimal('0.00'), model_id, None, None)
else:
    logger.info(f"üîß DRY-RUN: Would deduct {price} from user {user_id} (NOT DEDUCTED)")
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û** ‚Äî –±–∞–ª–∞–Ω—Å –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ DRY_RUN

### üìç –ü—Ä–æ–≤–µ—Ä–∫–∞ DRY_RUN –≤ `poll_task_status`:

#### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ (—Å—Ç—Ä–æ–∫–∞ 23314):
```python
dry_run = is_dry_run() or not allow_real_generation()

if dry_run:
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º–æ–∫–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    gateway = get_kie_gateway()
    result = await gateway.create_task(model_id, api_params)
    task_id = result.get('taskId', f"dry_run_{hash(model_id) % 10000}")
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º–æ–∫–æ–≤—ã–π URL
    mock_url = f"https://example.com/mock/{model_id}/{task_id}{ext}"
    
    # –ù–ï —Å–ø–∏—Å—ã–≤–∞–µ–º –±–∞–ª–∞–Ω—Å
    logger.info(f"üîß DRY-RUN: Would deduct {price} from user {user_id} (NOT DEDUCTED)")
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û** ‚Äî –±–∞–ª–∞–Ω—Å –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è MockKieGateway

---

## ‚úÖ 3. –ü–†–û–í–ï–†–ö–ê MockKieGateway

### üìç `kie_gateway.py`:

#### ‚úÖ `MockKieGateway.create_task()` (—Å—Ç—Ä–æ–∫–∞ 95):
```python
async def create_task(self, model_id: str, params: Dict[str, Any]) -> Dict[str, Any]:
    # –°–∏–º—É–ª–∏—Ä—É–µ–º –∑–∞–¥–µ—Ä–∂–∫—É —Å–µ—Ç–∏
    delay = 0.05 + (hash(model_id) % 100) / 1000  # 50-150ms
    await asyncio.sleep(delay)
    
    # –°–æ–∑–¥–∞–µ–º –º–æ–∫–æ–≤—ã–π task_id
    task_id = f"mock_task_{self._task_counter}_{hash(model_id) % 10000}"
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–¥–∞—á—É
    self._tasks[task_id] = {...}
    
    return {
        'ok': True,
        'taskId': task_id,
        'status': 'waiting'
    }
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û** ‚Äî –Ω–µ –¥–µ–ª–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–æ–∫–æ–≤—ã–π taskId

#### ‚úÖ `MockKieGateway.get_task_status()` (—Å—Ç—Ä–æ–∫–∞ 124):
```python
async def get_task_status(self, task_id: str) -> Dict[str, Any]:
    # –°–∏–º—É–ª–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å: waiting -> queuing -> generating -> success
    if elapsed < 0.1:
        status = 'waiting'
    elif elapsed < 0.2:
        status = 'queuing'
    elif elapsed < 0.5:
        status = 'generating'
    else:
        status = 'success'
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º mock URLs
        result['result'] = {
            'resultUrls': task.get('result_urls', [])
        }
    
    return result
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û** ‚Äî —Å–∏–º—É–ª–∏—Ä—É–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–æ–∫–æ–≤—ã–µ resultUrls

#### ‚úÖ `get_kie_gateway()` (—Å—Ç—Ä–æ–∫–∞ 206):
```python
def get_kie_gateway() -> KieGateway:
    if _gateway_instance is None:
        if should_use_mock_gateway():
            logger.info("üîß Using MockKieGateway (TEST_MODE or ALLOW_REAL_GENERATION=0)")
            _gateway_instance = MockKieGateway()
        else:
            logger.info("‚úÖ Using RealKieGateway")
            _gateway_instance = RealKieGateway()
    
    return _gateway_instance
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û** ‚Äî –≤ TEST_MODE/DRY_RUN –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç MockKieGateway

---

## ‚ö†Ô∏è 4. –ù–ê–ô–î–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –í –¢–ï–°–¢–ê–•

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:

#### 1. **–¢–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É outbox**
- **–ü—Ä–æ–±–ª–µ–º–∞:** –í `test_main_menu.py` (—Å—Ç—Ä–æ–∫–∞ 24) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `result['outbox']['messages']`, –Ω–æ –≤ `ptb_harness.py` —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `outbox` –¥—Ä—É–≥–∞—è
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `test_main_menu.py`, —Å—Ç—Ä–æ–∫–∞ 24
- **–û–∂–∏–¥–∞–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:** `result['outbox']['messages']`
- **–†–µ–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:** `result['outbox']['messages']` (–∏–∑ `ptb_harness.py`, —Å—Ç—Ä–æ–∫–∞ 195)
- **–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è **–ù–£–ñ–ù–û –ü–†–û–í–ï–†–ò–¢–¨** ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π, –Ω–æ –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è

#### 2. **–¢–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Ä–µ–∞–ª—å–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞**
- **–ü—Ä–æ–±–ª–µ–º–∞:** –í —Ç–µ—Å—Ç–∞—Ö –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ `subtract_user_balance` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ DRY_RUN
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å mock –¥–ª—è `subtract_user_balance` –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–Ω –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è

#### 3. **–¢–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ HTTP –∑–∞–ø—Ä–æ—Å—ã**
- **–ü—Ä–æ–±–ª–µ–º–∞:** –í —Ç–µ—Å—Ç–∞—Ö –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ `aiohttp.ClientSession` –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É, —á—Ç–æ MockKieGateway –Ω–µ –¥–µ–ª–∞–µ—Ç HTTP –∑–∞–ø—Ä–æ—Å–æ–≤

### üü° –ù–µ–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:

#### 1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ `dry_run`**
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ `dry_run` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã –≤ `confirm_generation` (—Å—Ç—Ä–æ–∫–∏ 11255 –∏ 11405)
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í—ã–Ω–µ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –≤ –Ω–∞—á–∞–ª–æ —Ñ—É–Ω–∫—Ü–∏–∏

#### 2. **–¢–µ—Å—Ç—ã –Ω–µ –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å–µ –º–æ–¥–µ–ª–∏**
- **–ü—Ä–æ–±–ª–µ–º–∞:** –í `test_models_menu_coverage.py` (—Å—Ç—Ä–æ–∫–∞ 54) —Ç–µ—Å—Ç–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 10 –º–æ–¥–µ–ª–µ–π
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –º–æ–¥–µ–ª–∏ –∏–ª–∏ —É–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ

---

## ‚úÖ 5. –ü–†–û–í–ï–†–ö–ê –õ–û–ì–ò–ö–ò –ì–ï–ù–ï–†–ê–¶–ò–ò

### üìç `confirm_generation` —Ñ—É–Ω–∫—Ü–∏—è:

#### ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ —á–µ—Ä–µ–∑ gateway:
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –°—Ç—Ä–æ–∫–∞ 11322 (`result = await gateway.create_task(model_id, api_params)`)
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `get_kie_gateway()`, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç MockKieGateway –≤ —Ç–µ—Å—Ç–∞—Ö

#### ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ taskId:
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –°—Ç—Ä–æ–∫–∞ 11340 (`task_id = result.get('taskId')`)
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û** ‚Äî –ø–æ–ª—É—á–∞–µ—Ç taskId –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ gateway

#### ‚úÖ –ó–∞–ø—É—Å–∫ polling:
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –°—Ç—Ä–æ–∫–∞ 11401 (`asyncio.create_task(poll_task_status(...))`)
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û** ‚Äî –∑–∞–ø—É—Å–∫–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π polling –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

### üìç `poll_task_status` —Ñ—É–Ω–∫—Ü–∏—è:

#### ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏:
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –°—Ç—Ä–æ–∫–∞ ~23613 (`result = await gateway.get_task_status(task_id)`)
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `get_kie_gateway()`, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç MockKieGateway –≤ —Ç–µ—Å—Ç–∞—Ö

#### ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –°—Ç—Ä–æ–∫–∞ ~23684 (`dry_run = is_dry_run() or not allow_real_generation()`)
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û** ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç DRY_RUN –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º –±–∞–ª–∞–Ω—Å–∞

---

## üìã 6. –ü–†–û–í–ï–†–ö–ê –ö–û–ù–ö–†–ï–¢–ù–´–• –¢–ï–°–¢–û–í

### ‚úÖ `test_main_menu.py`:

#### ‚úÖ `test_start_command`:
- **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:** –ö–æ–º–∞–Ω–¥–∞ `/start` –Ω–µ –ø–∞–¥–∞–µ—Ç
- **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:** –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `result['outbox']['messages']` ‚Äî –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É

#### ‚úÖ `test_start_command_no_crash`:
- **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:** –ö–æ–º–∞–Ω–¥–∞ `/start` –Ω–µ –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–∞—Ö
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û**

### ‚úÖ `test_models_menu_coverage.py`:

#### ‚úÖ `test_all_models_have_normalized_structure`:
- **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:** –í—Å–µ –º–æ–¥–µ–ª–∏ –∏–º–µ—é—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
- **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:** –ù–∞–ª–∏—á–∏–µ –ø–æ–ª–µ–π `id`, `title`, `generation_type`, `input_schema`, `help`
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û**

#### ‚úÖ `test_dry_run_no_real_api_calls`:
- **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:** –í DRY_RUN —Ä–µ–∂–∏–º–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è MockKieGateway
- **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:** –ù–µ –¥–µ–ª–∞—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–µ HTTP –∑–∞–ø—Ä–æ—Å—ã
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û**

### ‚úÖ `test_callbacks_smoke.py`:

#### ‚úÖ `test_all_known_callbacks_no_crash`:
- **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:** –í—Å–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ callback_data –Ω–µ –ø–∞–¥–∞—é—Ç
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û**

#### ‚úÖ `test_unknown_callback_handled_gracefully`:
- **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:** –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ callback –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û**

---

## ‚ö†Ô∏è 7. –ü–†–û–ë–õ–ï–ú–´ –í –¢–ï–°–¢–ê–•

### ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ outbox:

#### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `ptb_harness.py`, —Å—Ç—Ä–æ–∫–∏ 194-198
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞:** `result['outbox']['messages']`, `result['outbox']['edited_messages']`, `result['outbox']['callback_answers']`
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ—Å—Ç–∞—Ö:** ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û** ‚Äî –≤—Å–µ —Ç–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:

#### 1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –≤ DRY_RUN**
- **–ü—Ä–æ–±–ª–µ–º–∞:** –í —Ç–µ—Å—Ç–∞—Ö –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ `subtract_user_balance` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ DRY_RUN
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `test_models_menu_coverage.py`, —Å—Ç—Ä–æ–∫–∞ 129
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å mock –¥–ª—è `subtract_user_balance`:
  ```python
  from unittest.mock import patch
  with patch('bot_kie.subtract_user_balance') as mock_subtract, \
       patch('bot_kie.use_free_generation') as mock_free:
      result = await harness.process_callback(callback_data, user_id=12345)
      # –í DRY_RUN –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
      mock_subtract.assert_not_called()
      mock_free.assert_not_called()
  ```

#### 2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞**
- **–ü—Ä–æ–±–ª–µ–º–∞:** –í —Ç–µ—Å—Ç–∞—Ö –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ `subtract_user_balance` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ DRY_RUN
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å mock –¥–ª—è `subtract_user_balance`:
  ```python
  from unittest.mock import patch
  with patch('bot_kie.subtract_user_balance') as mock_subtract:
      result = await harness.process_callback(callback_data, user_id=12345)
      mock_subtract.assert_not_called()
  ```

#### 3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤**
- **–ü—Ä–æ–±–ª–µ–º–∞:** –í —Ç–µ—Å—Ç–∞—Ö –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ `aiohttp.ClientSession` –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É:
  ```python
  from unittest.mock import patch
  with patch('aiohttp.ClientSession') as mock_session:
      result = await harness.process_callback(callback_data, user_id=12345)
      mock_session.assert_not_called()
  ```

### üü° –ù–µ–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:

#### 1. **–¢–µ—Å—Ç—ã –Ω–µ –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å–µ –º–æ–¥–µ–ª–∏**
- **–ü—Ä–æ–±–ª–µ–º–∞:** –í `test_models_menu_coverage.py` (—Å—Ç—Ä–æ–∫–∞ 54) —Ç–µ—Å—Ç–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 10 –º–æ–¥–µ–ª–µ–π
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –º–æ–¥–µ–ª–∏ –∏–ª–∏ —É–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ

#### 2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ resultUrl**
- **–ü—Ä–æ–±–ª–µ–º–∞:** –í —Ç–µ—Å—Ç–∞—Ö –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ `resultUrl` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É:
  ```python
  assert 'resultUrl' in result or 'resultUrls' in result
  ```

---

## üìã 8. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–õ–£–ß–®–ï–ù–ò–Æ –¢–ï–°–¢–û–í

### üî¥ –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:

1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É outbox –≤ —Ç–µ—Å—Ç–∞—Ö**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç `ptb_harness.py`
   - –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

2. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞**
   - –î–æ–±–∞–≤–∏—Ç—å mock –¥–ª—è `subtract_user_balance`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–Ω –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ DRY_RUN

3. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–µ–∞–ª—å–Ω—ã—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤**
   - –î–æ–±–∞–≤–∏—Ç—å mock –¥–ª—è `aiohttp.ClientSession`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–Ω –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ç–µ—Å—Ç–∞—Ö

### üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:

1. **–£–≤–µ–ª–∏—á–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ –º–æ–¥–µ–ª–µ–π**
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –º–æ–¥–µ–ª–∏, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 10
   - –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

2. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É resultUrl**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `resultUrl` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç URL (png –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, mp4 –¥–ª—è –≤–∏–¥–µ–æ)

### üü¢ –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:

1. **–£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ—Å—Ç–∞—Ö**
   - –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ª–æ–≥–æ–≤ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫

---

## ‚úÖ 9. –ò–¢–û–ì–û–í–´–ô –°–¢–ê–¢–£–°

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–í—Å–µ —Ç–µ—Å—Ç—ã –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É** ‚úÖ
2. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ outbox –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞** ‚úÖ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–æ –≤—Å–µ—Ö —Ç–µ—Å—Ç–∞—Ö)
3. **DRY_RUN/TEST_MODE —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** ‚úÖ (–Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç MockKieGateway)
4. **MockKieGateway —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** ‚úÖ (–Ω–µ –¥–µ–ª–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤)
5. **–õ–æ–≥–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ gateway** ‚úÖ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç `get_kie_gateway()`)
6. **–ü—Ä–æ–≤–µ—Ä–∫–∞ `dry_run` –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç** ‚úÖ –≤ `confirm_generation` –∏ `poll_task_status`

### ‚ö†Ô∏è –ß—Ç–æ –Ω—É–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å:

1. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞** (–∫—Ä–∏—Ç–∏—á–Ω–æ) ‚Äî –Ω–µ—Ç mock –¥–ª—è `subtract_user_balance`
2. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–µ–∞–ª—å–Ω—ã—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤** (–∫—Ä–∏—Ç–∏—á–Ω–æ) ‚Äî –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ `aiohttp` –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
3. **–£–≤–µ–ª–∏—á–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ –º–æ–¥–µ–ª–µ–π** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) ‚Äî —Ç–µ—Å—Ç–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 10 –º–æ–¥–µ–ª–µ–π
4. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É resultUrl** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) ‚Äî –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ URL

---

## üéØ –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô

### –®–∞–≥ 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É outbox –≤ —Ç–µ—Å—Ç–∞—Ö
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É `outbox` –≤ `ptb_harness.py`
2. –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–Ω–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç

### –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
1. –î–æ–±–∞–≤–∏—Ç—å mock –¥–ª—è `subtract_user_balance` –≤ —Ç–µ—Å—Ç—ã
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–Ω –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ DRY_RUN
3. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è `use_free_generation`

### –®–∞–≥ 3: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–µ–∞–ª—å–Ω—ã—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
1. –î–æ–±–∞–≤–∏—Ç—å mock –¥–ª—è `aiohttp.ClientSession`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–Ω –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ç–µ—Å—Ç–∞—Ö
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ MockKieGateway –Ω–µ –¥–µ–ª–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–û–±—â–∏–π —Å—Ç–∞—Ç—É—Å:** ‚úÖ **–¢–ï–°–¢–´ –†–ê–ë–û–¢–ê–Æ–¢, –ù–û –¢–†–ï–ë–£–Æ–¢ –£–õ–£–ß–®–ï–ù–ò–ô**

–í—Å–µ —Ç–µ—Å—Ç—ã –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, DRY_RUN/TEST_MODE —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, MockKieGateway –Ω–µ –¥–µ–ª–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤. –û–¥–Ω–∞–∫–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è:

1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É outbox –≤ —Ç–µ—Å—Ç–∞—Ö** (–∫—Ä–∏—Ç–∏—á–Ω–æ)
2. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞** (–∫—Ä–∏—Ç–∏—á–Ω–æ)
3. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–µ–∞–ª—å–Ω—ã—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤** (–∫—Ä–∏—Ç–∏—á–Ω–æ)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**
1. üî¥ **–í—ã—Å–æ–∫–∏–π:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ (mock –¥–ª—è `subtract_user_balance`)
2. üî¥ **–í—ã—Å–æ–∫–∏–π:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–µ–∞–ª—å–Ω—ã—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ (mock –¥–ª—è `aiohttp.ClientSession`)
3. üü° **–°—Ä–µ–¥–Ω–∏–π:** –£–≤–µ–ª–∏—á–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ –º–æ–¥–µ–ª–µ–π (—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –º–æ–¥–µ–ª–∏, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 10)
4. üü¢ **–ù–∏–∑–∫–∏–π:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É resultUrl (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç URL: png/mp4)

---

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –î–ª—è –ø–æ–ª–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Å –ø–æ–º–æ—â—å—é `make test` –∏–ª–∏ `pytest tests/`. –ë–µ–∑ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø—Ä–æ—Ö–æ–¥—è—Ç –ª–∏ –æ–Ω–∏ —É—Å–ø–µ—à–Ω–æ.

